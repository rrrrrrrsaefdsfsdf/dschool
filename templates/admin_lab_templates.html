{% extends "base.html" %}
{% block title %}–®–∞–±–ª–æ–Ω—ã –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üé® –®–∞–±–ª–æ–Ω—ã –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç</h2>
        <div>
            <a href="{{ url_for('admin.import_existing_templates') }}" class="btn btn-warning me-2">
                <i class="fas fa-download"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
            </a>
            <a href="{{ url_for('admin.admin_lab_template_new') }}" class="btn btn-success">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
            </a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if templates %}
        <div class="row">
            {% for template in templates %}
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ template.name }}</h5>
                            <small class="badge bg-light text-dark">ID: {{ template.id }}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">{{ template.description or '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' }}</p>

                        <div class="mb-2">
                            <strong>–¢–∏–ø:</strong>
                            <span class="badge bg-info">{{ template.template_type }}</span>
                        </div>

                        <div class="mb-3">
                            <strong>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ª–∞–±–∞—Ö:</strong>
                            <span class="badge bg-secondary">{{ template.labs.count() }}</span>
                            {% if template.labs.count() > 0 %}
                                <small class="text-muted d-block">
                                    {% for lab in template.labs.limit(3) %}
                                        {{ lab.title }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if template.labs.count() > 3 %}...{% endif %}
                                </small>
                            {% endif %}
                        </div>

                        <div class="btn-group-vertical w-100" role="group">
                            <div class="btn-group btn-group-sm mb-2" role="group">
                                <a href="{{ url_for('admin.admin_lab_template_edit', id=template.id) }}"
                                   class="btn btn-primary">
                                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </a>
                                <a href="{{ url_for('admin.admin_lab_template_preview', id=template.id) }}"
                                   class="btn btn-info" target="_blank">
                                    <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                                </a>
                            </div>

                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-warning" onclick="duplicateTemplate({{ template.id }})">
                                    <i class="fas fa-copy"></i> –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button class="btn btn-danger"
                                        onclick="deleteTemplate({{ template.id }}, '{{ template.name }}', {{ template.labs.count() }})"
                                        {% if template.labs.count() > 0 %}
                                        title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è—Ö"
                                        disabled
                                        {% endif %}>
                                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted small">
                        <div class="d-flex justify-content-between">
                            <span>–°–æ–∑–¥–∞–Ω: {{ template.created_at.strftime('%d.%m.%Y') if template.created_at else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</span>
                            <span>–ò–∑–º–µ–Ω—ë–Ω: {{ template.updated_at.strftime('%d.%m.%Y') if template.updated_at else '–ù–∏–∫–æ–≥–¥–∞' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle fa-3x mb-3"></i>
            <h5>–®–∞–±–ª–æ–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
            <p class="mb-3">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —à–∞–±–ª–æ–Ω –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ</p>
            <div>
                <a href="{{ url_for('admin.admin_lab_template_new') }}" class="btn btn-success me-2">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
                </a>
                <a href="{{ url_for('admin.import_existing_templates') }}" class="btn btn-warning">
                    <i class="fas fa-download"></i> –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω "<span id="templateName"></span>"?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞—è) -->
<form id="duplicateForm" method="POST" style="display: none;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="action" value="duplicate">
    <input type="hidden" name="template_id" id="duplicateTemplateId">
</form>

<script>
function duplicateTemplate(templateId) {
    if (confirm('–°–æ–∑–¥–∞—Ç—å –∫–æ–ø–∏—é —ç—Ç–æ–≥–æ —à–∞–±–ª–æ–Ω–∞?')) {
        document.getElementById('duplicateTemplateId').value = templateId;
        document.getElementById('duplicateForm').action = '{{ url_for("admin.admin_lab_templates") }}';
        document.getElementById('duplicateForm').submit();
    }
}

function deleteTemplate(templateId, templateName, labsCount) {
    if (labsCount > 0) {
        alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è—Ö!');
        return;
    }

    document.getElementById('templateName').textContent = templateName;
    document.getElementById('deleteForm').action = '{{ url_for("admin.delete_lab_template", id=0) }}'.replace('0', templateId);

    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
}

// –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ –∞–ª–µ—Ä—Ç–æ–≤
window.addEventListener('DOMContentLoaded', function() {
    setTimeout(function() {
        var alerts = document.querySelectorAll('.alert:not(.alert-info)');
        alerts.forEach(function(alert) {
            var bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 5000);
});
</script>

<style>
.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-group-vertical .btn-group {
    width: 100%;
}

.btn-group-vertical .btn-group .btn {
    flex: 1;
}

.card-footer {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}
</style>
{% endblock %}